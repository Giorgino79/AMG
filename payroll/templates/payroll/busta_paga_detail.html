{% extends "base.html" %}
{% load static %}

{% block title %}Busta Paga {{ busta.mese|stringformat:"02d" }}/{{ busta.anno }} - {{ busta.user.get_full_name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'users:user_list' %}">Dipendenti</a></li>
<li class="breadcrumb-item"><a href="{% url 'users:user_detail' busta.user.pk %}">{{ busta.user.get_full_name }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'payroll:busta_paga_list' busta.user.pk %}">Buste Paga</a></li>
<li class="breadcrumb-item active">{{ busta.mese|stringformat:"02d" }}/{{ busta.anno }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-receipt me-2"></i>Busta Paga {{ busta.mese|stringformat:"02d" }}/{{ busta.anno }}</h2>
            <p class="text-muted mb-0">
                Dipendente: <strong>{{ busta.user.get_full_name }}</strong> |
                Elaborata il: {{ busta.data_elaborazione|date:"d/m/Y" }}
            </p>
        </div>
        <div class="col-md-4 text-end">
            {% if busta.confermata %}
            <span class="badge bg-success fs-5">Confermata</span>
            {% else %}
            <span class="badge bg-warning text-dark fs-5">Bozza</span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Colonna Sinistra: Dettagli Ore -->
        <div class="col-lg-4">
            <!-- Ore Lavorate -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Ore Lavorate</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ordinarie:</span>
                        <strong>{{ busta.ore_ordinarie|floatformat:2 }}h</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Straord. Feriale:</span>
                        <strong class="text-info">{{ busta.ore_straordinario_feriale|floatformat:2 }}h</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Straord. Festivo:</span>
                        <strong class="text-info">{{ busta.ore_straordinario_festivo|floatformat:2 }}h</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span>Straord. Notturno:</span>
                        <strong class="text-info">{{ busta.ore_straordinario_notturno|floatformat:2 }}h</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <strong>Totale Ore:</strong>
                        {% with tot=busta.ore_ordinarie|add:busta.ore_straordinario_feriale|add:busta.ore_straordinario_festivo|add:busta.ore_straordinario_notturno %}
                        <strong class="text-primary fs-5">{{ tot|floatformat:2 }}h</strong>
                        {% endwith %}
                    </div>
                </div>
            </div>

            <!-- Assenze -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-calendar-x me-2"></i>Assenze</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ferie:</span>
                        <strong>{{ busta.ore_ferie|floatformat:2 }}h</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>ROL:</span>
                        <strong>{{ busta.ore_rol|floatformat:2 }}h</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Permessi:</span>
                        <strong>{{ busta.ore_permessi|floatformat:2 }}h</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Malattia:</span>
                        <strong>{{ busta.ore_malattia|floatformat:2 }}h</strong>
                    </div>
                </div>
            </div>

            <!-- TFR -->
            <div class="card shadow-sm bg-success bg-opacity-10 border-success">
                <div class="card-body text-center">
                    <small class="text-muted d-block">TFR Maturato</small>
                    <h3 class="mb-0 text-success">€ {{ busta.tfr_maturato|floatformat:2 }}</h3>
                </div>
            </div>
        </div>

        <!-- Colonna Destra: Voci Economiche -->
        <div class="col-lg-8">
            <!-- Competenze -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-cash-stack me-2"></i>Competenze (Retribuzione Lorda)</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Descrizione</th>
                                    <th class="text-center">Quantità</th>
                                    <th class="text-end">Importo Unit.</th>
                                    <th class="text-end">Totale</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for voce in competenze %}
                                <tr>
                                    <td>{{ voce.descrizione }}</td>
                                    <td class="text-center">
                                        {% if voce.quantita %}{{ voce.quantita|floatformat:2 }}{% else %}-{% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if voce.importo_unitario %}€ {{ voce.importo_unitario|floatformat:2 }}{% else %}-{% endif %}
                                    </td>
                                    <td class="text-end"><strong>€ {{ voce.importo_totale|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="3" class="text-end">Imponibile Fiscale:</th>
                                    <th class="text-end text-success">€ {{ busta.imponibile_fiscale|floatformat:2 }}</th>
                                </tr>
                                <tr>
                                    <th colspan="3" class="text-end">Imponibile Contributivo:</th>
                                    <th class="text-end text-success">€ {{ busta.imponibile_contributivo|floatformat:2 }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Trattenute -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-dash-circle me-2"></i>Trattenute</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Descrizione</th>
                                    <th class="text-end">Importo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for voce in trattenute %}
                                <tr>
                                    <td>{{ voce.descrizione }}</td>
                                    <td class="text-end text-danger"><strong>€ {{ voce.importo_totale|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                                {% if busta.altre_trattenute > 0 %}
                                <tr>
                                    <td>Altre Trattenute</td>
                                    <td class="text-end text-danger"><strong>€ {{ busta.altre_trattenute|floatformat:2 }}</strong></td>
                                </tr>
                                {% endif %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th class="text-end">Totale Trattenute:</th>
                                    {% with tot_tratt=busta.ritenute_previdenziali|add:busta.ritenute_irpef|add:busta.addizionale_regionale|add:busta.addizionale_comunale|add:busta.altre_trattenute %}
                                    <th class="text-end text-danger">€ {{ tot_tratt|floatformat:2 }}</th>
                                    {% endwith %}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Detrazioni -->
            {% if detrazioni %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Detrazioni</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Descrizione</th>
                                    <th class="text-end">Importo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for voce in detrazioni %}
                                <tr>
                                    <td>{{ voce.descrizione }}</td>
                                    <td class="text-end text-success"><strong>€ {{ voce.importo_totale|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th class="text-end">Totale Detrazioni:</th>
                                    <th class="text-end text-success">€ {{ busta.detrazioni_fiscali|floatformat:2 }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Netto in Busta -->
            <div class="card shadow-lg border-success border-3">
                <div class="card-body bg-success bg-opacity-10">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="bi bi-wallet2 me-2"></i>Netto in Busta
                            </h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <h2 class="mb-0 text-success">€ {{ busta.netto_busta|floatformat:2 }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pulsanti Azioni -->
    <div class="mt-4 d-flex justify-content-between">
        <a href="{% url 'payroll:busta_paga_list' busta.user.pk %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i>Torna alla Lista
        </a>
        <div>
            <button class="btn btn-outline-primary" onclick="window.print()">
                <i class="bi bi-printer me-1"></i>Stampa
            </button>
            <!-- Futuri: PDF, Email, ecc. -->
        </div>
    </div>
</div>

<style>
@media print {
    .btn, .breadcrumb, nav, footer { display: none !important; }
    .card { border: 1px solid #dee2e6 !important; box-shadow: none !important; }
}
</style>
{% endblock %}
