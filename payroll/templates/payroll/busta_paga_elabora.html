{% extends "base.html" %}
{% load static %}

{% block title %}Elabora Busta Paga - {{ user_obj.get_full_name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'users:user_list' %}">Dipendenti</a></li>
<li class="breadcrumb-item"><a href="{% url 'users:user_detail' user_obj.pk %}">{{ user_obj.get_full_name }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'payroll:busta_paga_list' user_obj.pk %}">Buste Paga</a></li>
<li class="breadcrumb-item active">Elabora Busta</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2><i class="bi bi-calculator me-2"></i>Elabora Busta Paga</h2>
                    <p class="text-muted">Dipendente: <strong>{{ user_obj.get_full_name }}</strong></p>
                </div>
                <div>
                    <a href="{% url 'payroll:manuale_payroll' %}" target="_blank" class="btn btn-info btn-sm">
                        <i class="bi bi-book me-1"></i>Manuale
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}

        <!-- Periodo -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Periodo di Riferimento</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="mese" class="form-label">Mese *</label>
                        <select class="form-select" id="mese" name="mese" required>
                            <option value="1" {% if mese_default == 1 %}selected{% endif %}>Gennaio</option>
                            <option value="2" {% if mese_default == 2 %}selected{% endif %}>Febbraio</option>
                            <option value="3" {% if mese_default == 3 %}selected{% endif %}>Marzo</option>
                            <option value="4" {% if mese_default == 4 %}selected{% endif %}>Aprile</option>
                            <option value="5" {% if mese_default == 5 %}selected{% endif %}>Maggio</option>
                            <option value="6" {% if mese_default == 6 %}selected{% endif %}>Giugno</option>
                            <option value="7" {% if mese_default == 7 %}selected{% endif %}>Luglio</option>
                            <option value="8" {% if mese_default == 8 %}selected{% endif %}>Agosto</option>
                            <option value="9" {% if mese_default == 9 %}selected{% endif %}>Settembre</option>
                            <option value="10" {% if mese_default == 10 %}selected{% endif %}>Ottobre</option>
                            <option value="11" {% if mese_default == 11 %}selected{% endif %}>Novembre</option>
                            <option value="12" {% if mese_default == 12 %}selected{% endif %}>Dicembre</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="anno" class="form-label">Anno *</label>
                        <input type="number" class="form-control" id="anno" name="anno" value="{{ anno_default }}" min="2020" max="2100" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ore Lavorate -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Ore Lavorate</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="ore_ordinarie" class="form-label">Ore Ordinarie *</label>
                        <input type="number" step="0.01" class="form-control" id="ore_ordinarie" name="ore_ordinarie" value="176.00" required>
                        <small class="form-text text-muted">Circa 22 giorni × 8 ore</small>
                    </div>
                    <div class="col-md-6">
                        <label for="ore_straordinario_feriale" class="form-label">Ore Straordinario Feriale</label>
                        <input type="number" step="0.01" class="form-control" id="ore_straordinario_feriale" name="ore_straordinario_feriale" value="0.00">
                        <small class="form-text text-muted">Maggiorazione: +15%</small>
                    </div>
                    <div class="col-md-6">
                        <label for="ore_straordinario_festivo" class="form-label">Ore Straordinario Festivo</label>
                        <input type="number" step="0.01" class="form-control" id="ore_straordinario_festivo" name="ore_straordinario_festivo" value="0.00">
                        <small class="form-text text-muted">Maggiorazione: +30%</small>
                    </div>
                    <div class="col-md-6">
                        <label for="ore_straordinario_notturno" class="form-label">Ore Straordinario Notturno</label>
                        <input type="number" step="0.01" class="form-control" id="ore_straordinario_notturno" name="ore_straordinario_notturno" value="0.00">
                        <small class="form-text text-muted">Maggiorazione: +50%</small>
                    </div>
                </div>

                <!-- Totale Ore Calcolato -->
                <div class="alert alert-info mt-3">
                    <strong>Totale Ore: <span id="totale_ore">176.00</span>h</strong>
                </div>
            </div>
        </div>

        <!-- Assenze -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-calendar-x me-2"></i>Assenze</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="ore_ferie" class="form-label">Ore Ferie</label>
                        <input type="number" step="0.01" class="form-control" id="ore_ferie" name="ore_ferie" value="0.00">
                    </div>
                    <div class="col-md-6">
                        <label for="ore_rol" class="form-label">Ore ROL</label>
                        <input type="number" step="0.01" class="form-control" id="ore_rol" name="ore_rol" value="0.00">
                    </div>
                    <div class="col-md-6">
                        <label for="ore_permessi" class="form-label">Ore Permessi</label>
                        <input type="number" step="0.01" class="form-control" id="ore_permessi" name="ore_permessi" value="0.00">
                    </div>
                    <div class="col-md-6">
                        <label for="ore_malattia" class="form-label">Ore Malattia</label>
                        <input type="number" step="0.01" class="form-control" id="ore_malattia" name="ore_malattia" value="0.00">
                    </div>
                </div>
            </div>
        </div>

        <!-- Info -->
        <div class="alert alert-primary">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Nota:</strong> Il sistema calcolerà automaticamente:
            <ul class="mb-0 mt-2">
                <li>Retribuzione base e straordinari</li>
                <li>Elementi retributivi del CCNL (contingenza, EDR, indennità)</li>
                <li>Contributi INPS (9,19%)</li>
                <li>IRPEF con scaglioni progressivi</li>
                <li>Addizionali regionali e comunali</li>
                <li>Detrazioni fiscali</li>
                <li>TFR (6,91%)</li>
                <li>Maturazione ferie e permessi del mese</li>
            </ul>
        </div>

        <!-- Pulsanti -->
        <div class="d-flex justify-content-between">
            <a href="{% url 'payroll:busta_paga_list' user_obj.pk %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i>Annulla
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-calculator-fill me-1"></i>Elabora Busta Paga
            </button>
        </div>
    </form>
</div>

<script>
// Calcola totale ore in tempo reale
function calcolaTotale() {
    const ordinarie = parseFloat(document.getElementById('ore_ordinarie').value) || 0;
    const feriale = parseFloat(document.getElementById('ore_straordinario_feriale').value) || 0;
    const festivo = parseFloat(document.getElementById('ore_straordinario_festivo').value) || 0;
    const notturno = parseFloat(document.getElementById('ore_straordinario_notturno').value) || 0;

    const totale = ordinarie + feriale + festivo + notturno;
    document.getElementById('totale_ore').textContent = totale.toFixed(2);
}

// Aggiungi listener a tutti i campi ore
['ore_ordinarie', 'ore_straordinario_feriale', 'ore_straordinario_festivo', 'ore_straordinario_notturno'].forEach(id => {
    document.getElementById(id).addEventListener('input', calcolaTotale);
});

// Calcola al caricamento
calcolaTotale();
</script>
{% endblock %}
