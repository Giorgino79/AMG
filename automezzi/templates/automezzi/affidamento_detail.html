{% extends 'commons_templates/base_detail.html' %}
{% load static %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'automezzi:dashboard' %}">Automezzi</a></li>
<li class="breadcrumb-item"><a href="{% url 'automezzi:affidamento_list' %}">Affidamenti</a></li>
<li class="breadcrumb-item active">{{ affidamento.automezzo.targa }}</li>
{% endblock %}

{% block page_title %}
<i class="fas fa-handshake me-2"></i>Affidamento {{ affidamento.automezzo.targa }}
{% endblock %}

{% block page_subtitle %}
<p class="text-muted mb-0">{{ affidamento.automezzo.marca }} {{ affidamento.automezzo.modello }} → {{ affidamento.user.get_full_name|default:affidamento.user.username }}</p>
{% endblock %}

{% block status_badge %}
{% if affidamento.stato == 'in_attesa' %}
    <span class="badge bg-warning fs-6">In attesa di accettazione</span>
{% elif affidamento.stato == 'accettato' %}
    <span class="badge bg-info fs-6">Accettato</span>
{% elif affidamento.stato == 'in_corso' %}
    <span class="badge bg-primary fs-6">In corso</span>
{% elif affidamento.stato == 'completato' %}
    <span class="badge bg-success fs-6">Completato</span>
{% endif %}
{% endblock %}

{% block custom_actions %}
{% if affidamento.stato == 'accettato' or affidamento.stato == 'in_corso' %}
<a href="{% url 'automezzi:affidamento_rientro' affidamento.pk %}" class="list-group-item list-group-item-action text-success">
    <i class="bi bi-box-arrow-in-left"></i> Registra Rientro
</a>
{% endif %}
{% endblock %}

{% block detail_content %}
<div class="row">
    <!-- Stato -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Stato</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    {% if affidamento.stato == 'in_attesa' %}
                        <span class="badge bg-warning fs-6 px-3 py-2">In attesa di accettazione</span>
                    {% elif affidamento.stato == 'accettato' %}
                        <span class="badge bg-info fs-6 px-3 py-2">Accettato</span>
                    {% elif affidamento.stato == 'in_corso' %}
                        <span class="badge bg-primary fs-6 px-3 py-2">In corso</span>
                    {% elif affidamento.stato == 'completato' %}
                        <span class="badge bg-success fs-6 px-3 py-2">Completato</span>
                    {% endif %}
                </div>
                <ul class="list-unstyled">
                    <li class="mb-2"><strong>Creato il:</strong> {{ affidamento.data_creazione|date:"d/m/Y H:i" }}</li>
                    <li class="mb-2"><strong>Creato da:</strong> {{ affidamento.creato_da.get_full_name|default:affidamento.creato_da.username }}</li>
                    {% if affidamento.firma_accettazione %}
                    <li class="mb-2"><strong>Accettato il:</strong> {{ affidamento.data_accettazione|date:"d/m/Y H:i" }}</li>
                    {% endif %}
                    {% if affidamento.data_rientro %}
                    <li class="mb-2"><strong>Rientro il:</strong> {{ affidamento.data_rientro|date:"d/m/Y H:i" }}</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Dati Affidamento -->
    <div class="col-md-8 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>Dati Affidamento</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr><th class="text-muted" style="width:40%">Dipendente</th><td>{{ affidamento.user.get_full_name|default:affidamento.user.username }}</td></tr>
                            <tr><th class="text-muted">Automezzo</th><td><a href="{% url 'automezzi:automezzo_detail' affidamento.automezzo.pk %}">{{ affidamento.automezzo.targa }}</a> - {{ affidamento.automezzo.marca }} {{ affidamento.automezzo.modello }}</td></tr>
                            <tr><th class="text-muted">Periodo</th><td>{{ affidamento.data_inizio|date:"d/m/Y" }} → {{ affidamento.data_fine|date:"d/m/Y" }}</td></tr>
                            <tr><th class="text-muted">Scopo</th><td>{{ affidamento.scopo_viaggio }}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr><th class="text-muted" style="width:40%">Km Iniziali</th><td>{{ affidamento.km_iniziali|default:"-" }}</td></tr>
                            <tr><th class="text-muted">Km Finali</th><td>{{ affidamento.km_finali|default:"-" }}</td></tr>
                            <tr><th class="text-muted">Carburante</th><td>{{ affidamento.get_carburante_display }}</td></tr>
                            <tr>
                                <th class="text-muted">Carta Carburante</th>
                                <td>
                                    {% if affidamento.automezzo.carta_carburante %}
                                        {{ affidamento.automezzo.carta_carburante }}
                                        {% if affidamento.automezzo.pin_carta_carburante %}
                                            <br><small class="text-muted">PIN: {{ affidamento.automezzo.pin_carta_carburante }}</small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                {% if affidamento.note %}
                <div class="mt-3">
                    <strong>Note consegna:</strong>
                    <p class="mb-0">{{ affidamento.note }}</p>
                </div>
                {% endif %}

                {% if affidamento.note_rientro %}
                <div class="mt-3">
                    <strong>Note rientro:</strong>
                    <p class="mb-0">{{ affidamento.note_rientro }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_content %}
<!-- Video -->
<div class="row mt-3">
    {% if affidamento.video_stato_vettura %}
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-camera-video me-2"></i>Video Consegna</h5>
            </div>
            <div class="card-body">
                <video controls class="w-100" style="max-height: 400px;">
                    <source src="{{ affidamento.video_stato_vettura.url }}">
                    Il browser non supporta il tag video.
                </video>
            </div>
        </div>
    </div>
    {% endif %}

    {% if affidamento.video_rientro %}
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-camera-video me-2"></i>Video Rientro</h5>
            </div>
            <div class="card-body">
                <video controls class="w-100" style="max-height: 400px;">
                    <source src="{{ affidamento.video_rientro.url }}">
                    Il browser non supporta il tag video.
                </video>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
