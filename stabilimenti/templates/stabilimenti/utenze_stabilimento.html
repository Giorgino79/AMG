{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Utenze {{ stabilimento.nome }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'stabilimenti:list' %}">Stabilimenti</a></li>
<li class="breadcrumb-item"><a href="{% url 'stabilimenti:dettaglio' stabilimento.pk %}">{{ stabilimento.nome }}</a></li>
<li class="breadcrumb-item active">Utenze</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-lightning-charge me-2 text-warning"></i>Utenze {{ stabilimento.nome }}
        </h1>
        <div class="btn-group">
            <a href="{% url 'stabilimenti:dashboard_utenze' %}" class="btn btn-outline-secondary">
                <i class="bi bi-speedometer2 me-1"></i>Dashboard Generale
            </a>
            <a href="{% url 'stabilimenti:nuova_utenza' stabilimento_pk=stabilimento.pk %}" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Nuova Utenza
            </a>
        </div>
    </div>

    <!-- Statistiche rapide -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-cash-stack me-2"></i>Totale {{ anno_corrente }}
                </div>
                <div class="card-body text-center">
                    <span class="widget-stat text-success">
                        &euro;{% if stats_anno.totale_anno %}{{ stats_anno.totale_anno|floatformat:0|intcomma }}{% else %}0{% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-header second-color">
                    <i class="bi bi-graph-up me-2"></i>Media Mensile
                </div>
                <div class="card-body text-center">
                    <span class="widget-stat text-primary">
                        &euro;{% if stats_anno.media_mensile %}{{ stats_anno.media_mensile|floatformat:0|intcomma }}{% else %}0{% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-header third-color">
                    <i class="bi bi-receipt me-2"></i>Fatture Registrate
                </div>
                <div class="card-body text-center">
                    <span class="widget-stat">{{ stats_anno.count_fatture|default:0 }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-header fourth-color">
                    <i class="bi bi-clock-history me-2"></i>Prossime Scadenze
                </div>
                <div class="card-body text-center">
                    <span class="widget-stat text-warning">{{ prossime_scadenze.count }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonna sinistra: Lista Utenze -->
        <div class="col-lg-8">
            <div class="dashboard-widget">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="bi bi-list-ul text-primary me-2"></i>
                        Elenco Utenze ({{ page_obj.paginator.count|default:0 }})
                    </h5>
                </div>

                {% if page_obj %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Titolo</th>
                                <th>Tipo</th>
                                <th>Fornitore</th>
                                <th>Periodo</th>
                                <th class="text-end">Importo</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for utenza in page_obj %}
                            <tr>
                                <td>
                                    <a href="{% url 'stabilimenti:dettaglio_costo' utenza.pk %}" class="text-decoration-none fw-bold">
                                        {{ utenza.titolo|truncatechars:30 }}
                                    </a>
                                    <br>
                                    <small class="text-muted">
                                        <i class="bi bi-hash"></i>{{ utenza.numero_pratica }}
                                    </small>
                                </td>
                                <td>
                                    {% if utenza.causale == 'energia_elettrica' %}
                                        <span class="badge bg-warning text-dark"><i class="bi bi-lightning-charge me-1"></i>Elettrica</span>
                                    {% elif utenza.causale == 'gas_naturale' %}
                                        <span class="badge bg-danger"><i class="bi bi-fire me-1"></i>Gas</span>
                                    {% elif utenza.causale == 'acqua' %}
                                        <span class="badge bg-info"><i class="bi bi-droplet me-1"></i>Acqua</span>
                                    {% elif utenza.causale == 'telefonia' %}
                                        <span class="badge bg-success"><i class="bi bi-phone me-1"></i>Telefonia</span>
                                    {% elif utenza.causale == 'rifiuti' %}
                                        <span class="badge bg-secondary"><i class="bi bi-trash3 me-1"></i>Rifiuti</span>
                                    {% else %}
                                        <span class="badge bg-dark"><i class="bi bi-gear me-1"></i>Altro</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ utenza.fornitore.ragione_sociale|truncatechars:20 }}</strong>
                                </td>
                                <td>
                                    {% if utenza.periodo_fatturazione_da and utenza.periodo_fatturazione_a %}
                                        <small>{{ utenza.periodo_fatturazione_da|date:"d/m/y" }} - {{ utenza.periodo_fatturazione_a|date:"d/m/y" }}</small>
                                    {% elif utenza.data_fattura %}
                                        <small>{{ utenza.data_fattura|date:"d/m/Y" }}</small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                    {% if utenza.consumo_kwh %}
                                        <br><small class="text-warning"><i class="bi bi-lightning-charge"></i> {{ utenza.consumo_kwh|floatformat:0 }} kWh</small>
                                    {% endif %}
                                    {% if utenza.consumo_mc %}
                                        <br><small class="text-danger"><i class="bi bi-fire"></i> {{ utenza.consumo_mc|floatformat:0 }} mc</small>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <strong>&euro;{{ utenza.calcola_totale_con_iva|floatformat:2 }}</strong>
                                </td>
                                <td>
                                    {% if utenza.stato == 'pagato' %}
                                        <span class="badge bg-success">{{ utenza.get_stato_display }}</span>
                                    {% elif utenza.stato == 'fatturato' %}
                                        <span class="badge bg-info">{{ utenza.get_stato_display }}</span>
                                    {% elif utenza.stato == 'completato' %}
                                        <span class="badge bg-primary">{{ utenza.get_stato_display }}</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">{{ utenza.get_stato_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'stabilimenti:dettaglio_costo' utenza.pk %}" class="btn btn-outline-primary" title="Dettaglio">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if utenza.can_be_modified %}
                                        <a href="{% url 'stabilimenti:modifica_utenza' utenza.pk %}" class="btn btn-outline-warning" title="Modifica">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginazione -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Paginazione utenze" class="mt-3">
                    <ul class="pagination pagination-sm justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-lightning-charge fs-1 d-block mb-3"></i>
                    <p>Nessuna utenza registrata per questo stabilimento</p>
                    <a href="{% url 'stabilimenti:nuova_utenza' stabilimento_pk=stabilimento.pk %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>Aggiungi Prima Utenza
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Colonna destra: Scadenze e Ripartizione -->
        <div class="col-lg-4">
            <!-- Prossime Scadenze -->
            <div class="dashboard-widget mb-4">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="bi bi-clock text-warning me-2"></i>
                        Prossime Scadenze
                    </h5>
                </div>

                {% if prossime_scadenze %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <tbody>
                            {% for scadenza in prossime_scadenze %}
                            <tr>
                                <td>
                                    {% if scadenza.causale == 'energia_elettrica' %}
                                        <i class="bi bi-lightning-charge text-warning"></i>
                                    {% elif scadenza.causale == 'gas_naturale' %}
                                        <i class="bi bi-fire text-danger"></i>
                                    {% elif scadenza.causale == 'acqua' %}
                                        <i class="bi bi-droplet text-info"></i>
                                    {% elif scadenza.causale == 'telefonia' %}
                                        <i class="bi bi-phone text-success"></i>
                                    {% elif scadenza.causale == 'rifiuti' %}
                                        <i class="bi bi-trash3 text-secondary"></i>
                                    {% else %}
                                        <i class="bi bi-gear text-dark"></i>
                                    {% endif %}
                                    <strong class="ms-1">{{ scadenza.get_causale_display }}</strong>
                                    <br>
                                    <small class="text-muted">{{ scadenza.fornitore.ragione_sociale|truncatechars:25 }}</small>
                                </td>
                                <td class="text-end">
                                    <strong>{{ scadenza.data_scadenza_servizio|date:"d/m" }}</strong>
                                    <br>
                                    {% if scadenza.giorni_alla_scadenza <= 7 %}
                                        <span class="badge bg-danger">{{ scadenza.giorni_alla_scadenza }} gg</span>
                                    {% elif scadenza.giorni_alla_scadenza <= 15 %}
                                        <span class="badge bg-warning text-dark">{{ scadenza.giorni_alla_scadenza }} gg</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ scadenza.giorni_alla_scadenza }} gg</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center pb-3">
                    <a href="{% url 'stabilimenti:scadenze' %}" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-calendar3 me-1"></i>Tutte le Scadenze
                    </a>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-check fs-1 d-block mb-3"></i>
                    <p>Nessuna scadenza nei prossimi 60 giorni</p>
                </div>
                {% endif %}
            </div>

            <!-- Ripartizione per Tipo -->
            {% if stats_per_tipo %}
            <div class="dashboard-widget">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="bi bi-pie-chart text-info me-2"></i>
                        Ripartizione {{ anno_corrente }}
                    </h5>
                </div>

                <div class="p-3">
                    {% for tipo, importo in stats_per_tipo.items %}
                        {% if importo > 0 %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>
                                {% if 'Elettrica' in tipo %}
                                    <i class="bi bi-lightning-charge text-warning me-1"></i>
                                {% elif 'Gas' in tipo %}
                                    <i class="bi bi-fire text-danger me-1"></i>
                                {% elif 'Acqua' in tipo %}
                                    <i class="bi bi-droplet text-info me-1"></i>
                                {% elif 'Telefon' in tipo %}
                                    <i class="bi bi-phone text-success me-1"></i>
                                {% elif 'Rifiuti' in tipo %}
                                    <i class="bi bi-trash3 text-secondary me-1"></i>
                                {% else %}
                                    <i class="bi bi-gear text-dark me-1"></i>
                                {% endif %}
                                {{ tipo }}
                            </span>
                            <strong>&euro;{{ importo|floatformat:0|intcomma }}</strong>
                        </div>
                        <div class="progress mb-3" style="height: 6px;">
                            {% widthratio importo stats_anno.totale_anno 100 as percentuale %}
                            <div class="progress-bar {% if 'Elettrica' in tipo %}bg-warning{% elif 'Gas' in tipo %}bg-danger{% elif 'Acqua' in tipo %}bg-info{% elif 'Telefon' in tipo %}bg-success{% elif 'Rifiuti' in tipo %}bg-secondary{% else %}bg-dark{% endif %}"
                                 role="progressbar"
                                 style="width: {{ percentuale }}%"></div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Azioni Rapide -->
            <div class="dashboard-widget mt-4">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="bi bi-lightning me-2"></i>
                        Azioni Rapide
                    </h5>
                </div>
                <div class="p-3">
                    <div class="d-grid gap-2">
                        <a href="{% url 'stabilimenti:nuova_utenza' stabilimento_pk=stabilimento.pk %}" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-2"></i>Nuova Utenza
                        </a>
                        <a href="{% url 'stabilimenti:dettaglio' stabilimento.pk %}" class="btn btn-outline-secondary">
                            <i class="bi bi-building me-2"></i>Torna allo Stabilimento
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
