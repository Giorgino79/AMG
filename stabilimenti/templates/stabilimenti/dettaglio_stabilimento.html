{% extends 'commons_templates/base_detail.html' %}
{% load static %}
{% load humanize %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'stabilimenti:list' %}">Stabilimenti</a></li>
<li class="breadcrumb-item active">{{ stabilimento.nome }}</li>
{% endblock %}

{% block page_title %}
<i class="bi bi-building me-2"></i>{{ stabilimento.nome }}
{% endblock %}

{% block page_subtitle %}
<p class="text-muted mb-0">
    <i class="bi bi-geo-alt me-1"></i>{{ stabilimento.get_indirizzo_completo }}
    <span class="ms-3"><i class="bi bi-upc me-1"></i>Codice: {{ stabilimento.codice_stabilimento }}</span>
</p>
{% if stabilimento.telefono %}
<p class="text-muted mb-0">
    <i class="bi bi-telephone me-1"></i>{{ stabilimento.telefono }}
    {% if stabilimento.email_filiale %}
        <span class="ms-3"><i class="bi bi-envelope me-1"></i>{{ stabilimento.email_filiale }}</span>
    {% endif %}
</p>
{% endif %}
{% endblock %}

{% block status_badge %}
{% if stabilimento.attivo %}
    <span class="badge bg-success fs-6">Attivo</span>
{% else %}
    <span class="badge bg-secondary fs-6">Inattivo</span>
{% endif %}
{% endblock %}

{% block custom_actions %}
<a href="{% url 'stabilimenti:nuovo_costo_stabilimento' stabilimento.pk %}" class="list-group-item list-group-item-action text-primary">
    <i class="bi bi-plus-circle"></i> Nuovo Costo
</a>
<a href="{% url 'stabilimenti:nuovo_documento' stabilimento.pk %}" class="list-group-item list-group-item-action text-success">
    <i class="bi bi-upload"></i> Carica Documento
</a>
<a href="{% url 'stabilimenti:documenti' stabilimento.pk %}" class="list-group-item list-group-item-action">
    <i class="bi bi-folder"></i> Gestisci Documenti
</a>
<button type="button" class="list-group-item list-group-item-action" onclick="toggleStabilimento()">
    {% if stabilimento.attivo %}
        <i class="bi bi-pause-circle text-warning"></i> Disattiva
    {% else %}
        <i class="bi bi-play-circle text-success"></i> Riattiva
    {% endif %}
</button>
{% endblock %}

{% block detail_content %}
<div class="row">
    <!-- Colonna Sinistra - Informazioni Principali -->
    <div class="col-lg-8">
        <!-- Riepilogo Costi -->
        <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
            <div>
                <i class="bi bi-cash-stack me-2"></i>
                <strong>Costi Anno Corrente:</strong>
            </div>
            <div class="h4 mb-0">{{ costi_anno|floatformat:2 }}</div>
        </div>

        <!-- Informazioni Stabilimento -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informazioni Stabilimento</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Responsabili</h6>
                        {% if stabilimento.responsabile_operativo %}
                            <p class="mb-1">
                                <strong>Operativo:</strong>
                                {{ stabilimento.responsabile_operativo.get_full_name|default:stabilimento.responsabile_operativo.username }}
                            </p>
                        {% endif %}
                        {% if stabilimento.responsabile_amministrativo %}
                            <p class="mb-1">
                                <strong>Amministrativo:</strong>
                                {{ stabilimento.responsabile_amministrativo.get_full_name|default:stabilimento.responsabile_amministrativo.username }}
                            </p>
                        {% endif %}
                        {% if not stabilimento.responsabile_operativo and not stabilimento.responsabile_amministrativo %}
                            <p class="text-muted mb-1">Nessun responsabile assegnato</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Caratteristiche</h6>
                        {% if stabilimento.superficie_mq %}
                            <p class="mb-1"><strong>Superficie:</strong> {{ stabilimento.superficie_mq }} mq</p>
                        {% endif %}
                        {% if stabilimento.numero_piani %}
                            <p class="mb-1"><strong>Piani:</strong> {{ stabilimento.numero_piani }}</p>
                        {% endif %}
                        {% if stabilimento.anno_costruzione %}
                            <p class="mb-1"><strong>Anno costruzione:</strong> {{ stabilimento.anno_costruzione }}</p>
                        {% endif %}
                        {% if stabilimento.data_apertura %}
                            <p class="mb-1"><strong>Aperto dal:</strong> {{ stabilimento.data_apertura|date:"d/m/Y" }}</p>
                        {% endif %}
                        {% if not stabilimento.superficie_mq and not stabilimento.numero_piani and not stabilimento.anno_costruzione %}
                            <p class="text-muted mb-1">Caratteristiche non specificate</p>
                        {% endif %}
                    </div>
                </div>

                {% if stabilimento.note_generali %}
                    <hr>
                    <h6 class="text-muted">Note Generali</h6>
                    <p class="mb-0">{{ stabilimento.note_generali|linebreaks }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Costi Recenti -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-currency-euro me-2"></i>Costi Recenti</h5>
                <a href="{% url 'stabilimenti:nuovo_costo_stabilimento' stabilimento.pk %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus me-1"></i>Nuovo Costo
                </a>
            </div>
            <div class="card-body">
                {% if costi_recenti %}
                    <div class="list-group list-group-flush">
                        {% for costo in costi_recenti %}
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ costo.titolo }}</strong>
                                <br><small class="text-muted">{{ costo.fornitore.ragione_sociale }} - {{ costo.get_causale_display }}</small>
                                <br><small class="text-muted">{{ costo.data_creazione|date:"d/m/Y" }}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">{{ costo.calcola_totale_con_iva|floatformat:2 }}</div>
                                <span class="badge bg-{% if costo.stato == 'pagato' %}success{% elif costo.stato == 'fatturato' %}info{% else %}warning{% endif %}">
                                    {{ costo.get_stato_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'stabilimenti:costi_list' %}?stabilimento={{ stabilimento.pk }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-list me-1"></i>Vedi Tutti i Costi
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-receipt fa-2x mb-2"></i>
                        <p>Nessun costo registrato</p>
                        <a href="{% url 'stabilimenti:nuovo_costo_stabilimento' stabilimento.pk %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus me-1"></i>Aggiungi Primo Costo
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Documenti Recenti -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-file-earmark me-2"></i>Documenti Recenti</h5>
                <a href="{% url 'stabilimenti:nuovo_documento' stabilimento.pk %}" class="btn btn-sm btn-success">
                    <i class="bi bi-upload me-1"></i>Carica Documento
                </a>
            </div>
            <div class="card-body">
                {% if documenti_recenti %}
                    <div class="list-group list-group-flush">
                        {% for documento in documenti_recenti %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ documento.nome_documento }}</strong>
                                {% if documento.versione != '1.0' %}
                                    <span class="badge bg-info">v{{ documento.versione }}</span>
                                {% endif %}
                                <br><small class="text-muted">{{ documento.get_tipo_documento_display }}</small>
                                <br><small class="text-muted">{{ documento.data_inserimento|date:"d/m/Y H:i" }}</small>
                            </div>
                            <div>
                                {% if documento.is_scaduto %}
                                    <span class="badge bg-danger">Scaduto</span>
                                {% elif documento.data_scadenza %}
                                    <span class="badge bg-warning text-dark">Scade {{ documento.data_scadenza|date:"d/m/Y" }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'stabilimenti:documenti' stabilimento.pk %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-folder me-1"></i>Vedi Tutti i Documenti
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-folder2-open fa-2x mb-2"></i>
                        <p>Nessun documento caricato</p>
                        <a href="{% url 'stabilimenti:nuovo_documento' stabilimento.pk %}" class="btn btn-success btn-sm">
                            <i class="bi bi-upload me-1"></i>Carica Primo Documento
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Colonna Destra - Scadenze -->
    <div class="col-lg-4">
        <!-- Scadenze Prossime -->
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-clock me-2"></i>Scadenze Prossime</h5>
            </div>
            <div class="card-body">
                {% if scadenze_prossime %}
                    <div class="list-group list-group-flush">
                        {% for scadenza in scadenze_prossime %}
                        <div class="list-group-item {% if scadenza.is_scaduto %}list-group-item-danger{% elif scadenza.giorni_alla_scadenza <= 7 %}list-group-item-warning{% endif %}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ scadenza.titolo }}</strong>
                                    <br><small>{{ scadenza.get_causale_display }}</small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">{{ scadenza.data_scadenza_servizio|date:"d/m/Y" }}</div>
                                    {% if scadenza.is_scaduto %}
                                        <small class="text-danger">Scaduto</small>
                                    {% else %}
                                        <small class="text-muted">{{ scadenza.giorni_alla_scadenza }} giorni</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'stabilimenti:scadenze' %}" class="btn btn-outline-warning btn-sm">
                            <i class="bi bi-calendar me-1"></i>Dashboard Scadenze
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-calendar-check fa-2x mb-2"></i>
                        <p>Nessuna scadenza prossima</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block detail_extra_js %}
<script>
function toggleStabilimento() {
    const isAttivo = {{ stabilimento.attivo|yesno:'true,false' }};
    const azione = isAttivo ? 'disattivare' : 'riattivare';

    if (confirm(`Sei sicuro di voler ${azione} questo stabilimento?`)) {
        fetch('{% url "stabilimenti:toggle_attivo" stabilimento.pk %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Errore durante l\'operazione');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Errore durante l\'operazione');
        });
    }
}
</script>
{% endblock %}
