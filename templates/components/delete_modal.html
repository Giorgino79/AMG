{% comment %}
Componente Modal per Conferma Eliminazione

Uso:
    {% include 'components/delete_modal.html' with object=ordine delete_url=delete_url_name %}

Parametri:
    - object: L'oggetto da eliminare (required)
    - delete_url: Nome URL per delete (required) - es: 'vendite:ordine_delete'
    - modal_id: ID custom del modal (default: 'deleteModal')
    - modal_title: Titolo custom (default: 'Conferma Eliminazione')
    - object_name: Nome custom oggetto (default: object|default:"questo elemento")
    - cancel_text: Testo bottone annulla (default: 'Annulla')
    - confirm_text: Testo bottone conferma (default: 'Elimina')
    - use_soft_delete: Se true, fa soft delete via AJAX (default: false)

Esempio 1 - Delete normale:
    {% include 'components/delete_modal.html' with object=ordine delete_url='vendite:ordine_delete' %}

Esempio 2 - Delete custom:
    {% include 'components/delete_modal.html' with
        object=ordine
        delete_url='vendite:ordine_delete'
        modal_title='Elimina Ordine'
        confirm_text='Sì, elimina'
    %}

Esempio 3 - Soft delete via AJAX:
    {% include 'components/delete_modal.html' with
        object=ordine
        delete_url='vendite:ordine_soft_delete'
        use_soft_delete=True
    %}
{% endcomment %}

<!-- Modal -->
<div class="modal fade" id="{{ modal_id|default:'deleteModal' }}" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {{ modal_title|default:"Conferma Eliminazione" }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    Sei sicuro di voler eliminare <strong>{{ object_name|default:object|default:"questo elemento" }}</strong>?
                </p>
                {% if object.allegati.count > 0 %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-paperclip me-2"></i>
                    Attenzione: questo elemento ha <strong>{{ object.allegati.count }} allegati</strong> collegati.
                </div>
                {% endif %}
                <p class="text-muted small mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    {% if use_soft_delete %}
                    L'elemento sarà disattivato ma potrà essere ripristinato in seguito.
                    {% else %}
                    Questa azione non può essere annullata.
                    {% endif %}
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>
                    {{ cancel_text|default:"Annulla" }}
                </button>
                <form method="post" action="{% url delete_url object.pk %}" style="display: inline;"
                      {% if use_soft_delete %}class="soft-delete-form"{% endif %}>
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>
                        {{ confirm_text|default:"Elimina" }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% if use_soft_delete %}
<!-- Script per soft delete via AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.soft-delete-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Chiudi modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('{{ modal_id|default:"deleteModal" }}'));
                    modal.hide();

                    // Mostra messaggio successo
                    showAlert('success', data.message || 'Elemento eliminato con successo');

                    // Ricarica pagina o redirect
                    if (data.redirect_url) {
                        setTimeout(() => window.location.href = data.redirect_url, 1500);
                    } else {
                        setTimeout(() => window.location.reload(), 1500);
                    }
                } else {
                    showAlert('danger', data.message || 'Errore durante l\'eliminazione');
                }
            })
            .catch(error => {
                showAlert('danger', 'Errore di connessione');
                console.error('Error:', error);
            });
        });
    }
});

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
}
</script>
{% endif %}
